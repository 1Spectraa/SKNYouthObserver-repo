<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - The Daily News</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 2rem; background: white; }
        th, td { padding: 1rem; border: 1px solid #ddd; text-align: left; }
        th { background: #f4f4f4; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .role-admin { background: #ffebee; color: #c62828; }
        .role-editor { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><a href="index.html">Admin Panel</a></div>
        <ul class="nav-links"><li><a href="index.html">Back to Site</a></li></ul>
    </nav>

    <main class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h1>User Management</h1>
            <p id="admin-greeting"></p>
        </header>

        <table id="user-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>User ID</th>
                    <th>Current Role</th>
                    <th>Change Role</th>
                </tr>
            </thead>
            <tbody id="user-list">
                </tbody>
        </table>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        async function initAdmin() {
            // 1. Check if user is logged in
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // 2. Check if user is actually an admin
            const { data: profile } = await supabase
                .from('profiles')
                .select('role, email')
                .eq('id', user.id)
                .single();

            if (!profile || profile.role !== 'admin') {
                alert("Access Denied: Admins Only");
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('admin-greeting').innerText = `Logged in as: ${profile.email}`;
            loadUsers();
        }

        async function loadUsers() {
            const { data: profiles, error } = await supabase.from('profiles').select('*');
            
            if (error) {
                console.error(error);
                return;
            }

            const tbody = document.getElementById('user-list');
            tbody.innerHTML = profiles.map(p => `
                <tr>
                    <td>${p.email}</td>
                    <td><code>${p.id.substring(0,8)}...</code></td>
                    <td><span class="status-badge role-${p.role}">${p.role.toUpperCase()}</span></td>
                    <td>
                        <select onchange="updateUserRole('${p.id}', this.value)">
                            <option value="reader" ${p.role === 'reader' ? 'selected' : ''}>Reader</option>
                            <option value="editor" ${p.role === 'editor' ? 'selected' : ''}>Editor</option>
                            <option value="admin" ${p.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        async function updateUserRole(userId, newRole) {
            const { error } = await supabase
                .from('profiles')
                .update({ role: newRole })
                .eq('id', userId);

            if (error) {
                alert("Update failed: " + error.message);
            } else {
                alert("Role updated successfully!");
                loadUsers(); // Refresh list
            }
        }

        initAdmin();
    </script>
</body>
</html>